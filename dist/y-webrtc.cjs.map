{"version":3,"file":"y-webrtc.cjs","sources":["../src/crypto.js","../src/y-webrtc.js"],"sourcesContent":["/* eslint-env browser */\r\n\r\nimport * as encoding from 'lib0/encoding'\r\nimport * as decoding from 'lib0/decoding'\r\nimport * as promise from 'lib0/promise'\r\nimport * as error from 'lib0/error'\r\nimport * as string from 'lib0/string'\r\n\r\n/**\r\n * @param {string} secret\r\n * @param {string} roomName\r\n * @return {PromiseLike<CryptoKey>}\r\n */\r\nexport const deriveKey = (secret, roomName) => {\r\n  const secretBuffer = string.encodeUtf8(secret).buffer\r\n  const salt = string.encodeUtf8(roomName).buffer\r\n  return crypto.subtle.importKey(\r\n    'raw',\r\n    secretBuffer,\r\n    'PBKDF2',\r\n    false,\r\n    ['deriveKey']\r\n  ).then(keyMaterial =>\r\n    crypto.subtle.deriveKey(\r\n      {\r\n        name: 'PBKDF2',\r\n        salt,\r\n        iterations: 100000,\r\n        hash: 'SHA-256'\r\n      },\r\n      keyMaterial,\r\n      {\r\n        name: 'AES-GCM',\r\n        length: 256\r\n      },\r\n      true,\r\n      ['encrypt', 'decrypt']\r\n    )\r\n  )\r\n}\r\n\r\n/**\r\n * @param {Uint8Array} data data to be encrypted\r\n * @param {CryptoKey?} key\r\n * @return {PromiseLike<Uint8Array>} encrypted, base64 encoded message\r\n */\r\nexport const encrypt = (data, key) => {\r\n  if (!key) {\r\n    return /** @type {PromiseLike<Uint8Array>} */ (promise.resolve(data))\r\n  }\r\n  const iv = crypto.getRandomValues(new Uint8Array(12))\r\n  return crypto.subtle.encrypt(\r\n    {\r\n      name: 'AES-GCM',\r\n      iv\r\n    },\r\n    key,\r\n    data\r\n  ).then(cipher => {\r\n    const encryptedDataEncoder = encoding.createEncoder()\r\n    encoding.writeVarString(encryptedDataEncoder, 'AES-GCM')\r\n    encoding.writeVarUint8Array(encryptedDataEncoder, iv)\r\n    encoding.writeVarUint8Array(encryptedDataEncoder, new Uint8Array(cipher))\r\n    return encoding.toUint8Array(encryptedDataEncoder)\r\n  })\r\n}\r\n\r\n/**\r\n * @param {Object} data data to be encrypted\r\n * @param {CryptoKey?} key\r\n * @return {PromiseLike<Uint8Array>} encrypted data, if key is provided\r\n */\r\nexport const encryptJson = (data, key) => {\r\n  const dataEncoder = encoding.createEncoder()\r\n  encoding.writeAny(dataEncoder, data)\r\n  return encrypt(encoding.toUint8Array(dataEncoder), key)\r\n}\r\n\r\n/**\r\n * @param {Uint8Array} data\r\n * @param {CryptoKey?} key\r\n * @return {PromiseLike<Uint8Array>} decrypted buffer\r\n */\r\nexport const decrypt = (data, key) => {\r\n  if (!key) {\r\n    return /** @type {PromiseLike<Uint8Array>} */ (promise.resolve(data))\r\n  }\r\n  const dataDecoder = decoding.createDecoder(data)\r\n  const algorithm = decoding.readVarString(dataDecoder)\r\n  if (algorithm !== 'AES-GCM') {\r\n    promise.reject(error.create('Unknown encryption algorithm'))\r\n  }\r\n  const iv = decoding.readVarUint8Array(dataDecoder)\r\n  const cipher = decoding.readVarUint8Array(dataDecoder)\r\n  return crypto.subtle.decrypt(\r\n    {\r\n      name: 'AES-GCM',\r\n      iv\r\n    },\r\n    key,\r\n    cipher\r\n  ).then(data => new Uint8Array(data))\r\n}\r\n\r\n/**\r\n * @param {Uint8Array} data\r\n * @param {CryptoKey?} key\r\n * @return {PromiseLike<Object>} decrypted object\r\n */\r\nexport const decryptJson = (data, key) =>\r\n  decrypt(data, key).then(decryptedValue =>\r\n    decoding.readAny(decoding.createDecoder(new Uint8Array(decryptedValue)))\r\n  )\r\n","import * as ws from 'lib0/websocket'\r\nimport * as map from 'lib0/map'\r\nimport * as error from 'lib0/error'\r\nimport * as random from 'lib0/random'\r\nimport * as encoding from 'lib0/encoding'\r\nimport * as decoding from 'lib0/decoding'\r\nimport { Observable } from 'lib0/observable'\r\nimport * as logging from 'lib0/logging'\r\nimport * as promise from 'lib0/promise'\r\nimport * as bc from 'lib0/broadcastchannel'\r\nimport * as buffer from 'lib0/buffer'\r\nimport * as math from 'lib0/math'\r\nimport { createMutex } from 'lib0/mutex'\r\n\r\nimport * as Y from 'yjs' // eslint-disable-line\r\n// import Peer from 'simple-peer/simplepeer.min.js'\r\n\r\nimport * as syncProtocol from 'y-protocols/sync'\r\nimport * as awarenessProtocol from 'y-protocols/awareness'\r\n\r\nimport * as cryptoutils from './crypto.js'\r\n\r\nconst log = logging.createModuleLogger('y-webrtc')\r\n\r\nconst messageSync = 0\r\nconst messageQueryAwareness = 3\r\nconst messageAwareness = 1\r\nconst messageBcPeerId = 4\r\n\r\n/**\r\n * @type {Map<string, SignalingConn>}\r\n */\r\nconst signalingConns = new Map()\r\n\r\n/**\r\n * @type {Map<string,Room>}\r\n */\r\nconst rooms = new Map()\r\n\r\n/**\r\n * @param {Room} room\r\n */\r\nconst checkIsSynced = room => {\r\n  let synced = true\r\n  room.webrtcConns.forEach(peer => {\r\n    if (!peer.synced) {\r\n      synced = false\r\n    }\r\n  })\r\n  if ((!synced && room.synced) || (synced && !room.synced)) {\r\n    room.synced = synced\r\n    room.provider.emit('synced', [{ synced }])\r\n    log('synced ', logging.BOLD, room.name, logging.UNBOLD, ' with all peers')\r\n  }\r\n}\r\n\r\n/**\r\n * @param {Room} room\r\n * @param {Uint8Array} buf\r\n * @param {function} syncedCallback\r\n * @return {encoding.Encoder?}\r\n */\r\nconst readMessage = (room, buf, syncedCallback) => {\r\n  const decoder = decoding.createDecoder(buf)\r\n  const encoder = encoding.createEncoder()\r\n  const messageType = decoding.readVarUint(decoder)\r\n  if (room === undefined) {\r\n    return null\r\n  }\r\n  const awareness = room.awareness\r\n  const doc = room.doc\r\n  let sendReply = false\r\n  switch (messageType) {\r\n    case messageSync: {\r\n      encoding.writeVarUint(encoder, messageSync)\r\n      const syncMessageType = syncProtocol.readSyncMessage(decoder, encoder, doc, room)\r\n      if (syncMessageType === syncProtocol.messageYjsSyncStep2 && !room.synced) {\r\n        syncedCallback()\r\n      }\r\n      if (syncMessageType === syncProtocol.messageYjsSyncStep1) {\r\n        sendReply = true\r\n      }\r\n      break\r\n    }\r\n    case messageQueryAwareness:\r\n      encoding.writeVarUint(encoder, messageAwareness)\r\n      encoding.writeVarUint8Array(encoder, awarenessProtocol.encodeAwarenessUpdate(awareness, Array.from(awareness.getStates().keys())))\r\n      sendReply = true\r\n      break\r\n    case messageAwareness:\r\n      awarenessProtocol.applyAwarenessUpdate(awareness, decoding.readVarUint8Array(decoder), room)\r\n      break\r\n    case messageBcPeerId: {\r\n      const add = decoding.readUint8(decoder) === 1\r\n      const peerName = decoding.readVarString(decoder)\r\n      if (peerName !== room.peerId && ((room.bcConns.has(peerName) && !add) || (!room.bcConns.has(peerName) && add))) {\r\n        const removed = []\r\n        const added = []\r\n        if (add) {\r\n          room.bcConns.add(peerName)\r\n          added.push(peerName)\r\n        } else {\r\n          room.bcConns.delete(peerName)\r\n          removed.push(peerName)\r\n        }\r\n        room.provider.emit('peers', [{\r\n          added,\r\n          removed,\r\n          webrtcPeers: Array.from(room.webrtcConns.keys()),\r\n          bcPeers: Array.from(room.bcConns)\r\n        }])\r\n        broadcastBcPeerId(room)\r\n      }\r\n      break\r\n    }\r\n    default:\r\n      console.error('Unable to compute message')\r\n      return encoder\r\n  }\r\n  if (!sendReply) {\r\n    // nothing has been written, no answer created\r\n    return null\r\n  }\r\n  return encoder\r\n}\r\n\r\n/**\r\n * @param {WebrtcConn} peerConn\r\n * @param {Uint8Array} buf\r\n * @return {encoding.Encoder?}\r\n */\r\nconst readPeerMessage = (peerConn, buf) => {\r\n  const room = peerConn.room\r\n  log('received message from ', logging.BOLD, peerConn.remotePeerId, logging.GREY, ' (', room.name, ')', logging.UNBOLD, logging.UNCOLOR)\r\n  return readMessage(room, buf, () => {\r\n    peerConn.synced = true\r\n    log('synced ', logging.BOLD, room.name, logging.UNBOLD, ' with ', logging.BOLD, peerConn.remotePeerId)\r\n    checkIsSynced(room)\r\n  })\r\n}\r\n\r\n/**\r\n * @param {WebrtcConn} webrtcConn\r\n * @param {encoding.Encoder} encoder\r\n */\r\nconst sendWebrtcConn = (webrtcConn, encoder) => {\r\n  log('send message to ', logging.BOLD, webrtcConn.remotePeerId, logging.UNBOLD, logging.GREY, ' (', webrtcConn.room.name, ')', logging.UNCOLOR)\r\n  try {\r\n    webrtcConn.peer.send(encoding.toUint8Array(encoder))\r\n  } catch (e) {}\r\n}\r\n\r\n/**\r\n * @param {Room} room\r\n * @param {Uint8Array} m\r\n */\r\nconst broadcastWebrtcConn = (room, m) => {\r\n  log('broadcast message in ', logging.BOLD, room.name, logging.UNBOLD)\r\n  room.webrtcConns.forEach(conn => {\r\n    try {\r\n      conn.peer.send(m)\r\n    } catch (e) {}\r\n  })\r\n}\r\n\r\nexport class WebrtcConn {\r\n  /**\r\n   * @param {SignalingConn} signalingConn\r\n   * @param {boolean} initiator\r\n   * @param {string} remotePeerId\r\n   * @param {Room} room\r\n   */\r\n  constructor (signalingConn, initiator, remotePeerId, room) {\r\n    log('establishing connection to ', logging.BOLD, remotePeerId)\r\n    this.room = room\r\n    this.remotePeerId = remotePeerId\r\n    this.closed = false\r\n    this.connected = false\r\n    this.synced = false\r\n    /**\r\n     * @type {any}\r\n     */\r\n    /*\r\n    this.peer = new Peer({ initiator, ...room.provider.peerOpts })\r\n    this.peer.on('signal', signal => {\r\n      publishSignalingMessage(signalingConn, room, { to: remotePeerId, from: room.peerId, type: 'signal', signal })\r\n    })\r\n    this.peer.on('connect', () => {\r\n      log('connected to ', logging.BOLD, remotePeerId)\r\n      this.connected = true\r\n      // send sync step 1\r\n      const provider = room.provider\r\n      const doc = provider.doc\r\n      const awareness = room.awareness\r\n      const encoder = encoding.createEncoder()\r\n      encoding.writeVarUint(encoder, messageSync)\r\n      syncProtocol.writeSyncStep1(encoder, doc)\r\n      sendWebrtcConn(this, encoder)\r\n      const awarenessStates = awareness.getStates()\r\n      if (awarenessStates.size > 0) {\r\n        const encoder = encoding.createEncoder()\r\n        encoding.writeVarUint(encoder, messageAwareness)\r\n        encoding.writeVarUint8Array(encoder, awarenessProtocol.encodeAwarenessUpdate(awareness, Array.from(awarenessStates.keys())))\r\n        sendWebrtcConn(this, encoder)\r\n      }\r\n    })\r\n    this.peer.on('close', () => {\r\n      this.connected = false\r\n      this.closed = true\r\n      if (room.webrtcConns.has(this.remotePeerId)) {\r\n        room.webrtcConns.delete(this.remotePeerId)\r\n        room.provider.emit('peers', [{\r\n          removed: [this.remotePeerId],\r\n          added: [],\r\n          webrtcPeers: Array.from(room.webrtcConns.keys()),\r\n          bcPeers: Array.from(room.bcConns)\r\n        }])\r\n      }\r\n      checkIsSynced(room)\r\n      this.peer.destroy()\r\n      log('closed connection to ', logging.BOLD, remotePeerId)\r\n      announceSignalingInfo(room)\r\n    })\r\n    this.peer.on('error', err => {\r\n      log('Error in connection to ', logging.BOLD, remotePeerId, ': ', err)\r\n      announceSignalingInfo(room)\r\n    })\r\n    this.peer.on('data', data => {\r\n      const answer = readPeerMessage(this, data)\r\n      if (answer !== null) {\r\n        sendWebrtcConn(this, answer)\r\n      }\r\n    })\r\n    */\r\n  }\r\n\r\n  destroy () {\r\n    this.peer.destroy()\r\n  }\r\n}\r\n\r\n/**\r\n * @param {Room} room\r\n * @param {Uint8Array} m\r\n */\r\nconst broadcastBcMessage = (room, m) => cryptoutils.encrypt(m, room.key).then(data =>\r\n  room.mux(() =>\r\n    bc.publish(room.name, data)\r\n  )\r\n)\r\n\r\n/**\r\n * @param {Room} room\r\n * @param {Uint8Array} m\r\n */\r\nconst broadcastRoomMessage = (room, m) => {\r\n  if (room.bcconnected) {\r\n    broadcastBcMessage(room, m)\r\n  }\r\n  broadcastWebrtcConn(room, m)\r\n}\r\n\r\n/**\r\n * @param {Room} room\r\n */\r\nconst announceSignalingInfo = room => {\r\n  signalingConns.forEach(conn => {\r\n    // only subcribe if connection is established, otherwise the conn automatically subscribes to all rooms\r\n    if (conn.connected) {\r\n      conn.send({ type: 'subscribe', topics: [room.name] })\r\n      if (room.webrtcConns.size < room.provider.maxConns) {\r\n        publishSignalingMessage(conn, room, { type: 'announce', from: room.peerId })\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\n/**\r\n * @param {Room} room\r\n */\r\nconst broadcastBcPeerId = room => {\r\n  if (room.provider.filterBcConns) {\r\n    // broadcast peerId via broadcastchannel\r\n    const encoderPeerIdBc = encoding.createEncoder()\r\n    encoding.writeVarUint(encoderPeerIdBc, messageBcPeerId)\r\n    encoding.writeUint8(encoderPeerIdBc, 1)\r\n    encoding.writeVarString(encoderPeerIdBc, room.peerId)\r\n    broadcastBcMessage(room, encoding.toUint8Array(encoderPeerIdBc))\r\n  }\r\n}\r\n\r\nexport class Room {\r\n  /**\r\n   * @param {Y.Doc} doc\r\n   * @param {WebrtcProvider} provider\r\n   * @param {string} name\r\n   * @param {CryptoKey|null} key\r\n   */\r\n  constructor (doc, provider, name, key) {\r\n    /**\r\n     * Do not assume that peerId is unique. This is only meant for sending signaling messages.\r\n     *\r\n     * @type {string}\r\n     */\r\n    this.peerId = random.uuidv4()\r\n    this.doc = doc\r\n    /**\r\n     * @type {awarenessProtocol.Awareness}\r\n     */\r\n    this.awareness = provider.awareness\r\n    this.provider = provider\r\n    this.synced = false\r\n    this.name = name\r\n    // @todo make key secret by scoping\r\n    this.key = key\r\n    /**\r\n     * @type {Map<string, WebrtcConn>}\r\n     */\r\n    this.webrtcConns = new Map()\r\n    /**\r\n     * @type {Set<string>}\r\n     */\r\n    this.bcConns = new Set()\r\n    this.mux = createMutex()\r\n    this.bcconnected = false\r\n    /**\r\n     * @param {ArrayBuffer} data\r\n     */\r\n    this._bcSubscriber = data =>\r\n      cryptoutils.decrypt(new Uint8Array(data), key).then(m =>\r\n        this.mux(() => {\r\n          const reply = readMessage(this, m, () => {})\r\n          if (reply) {\r\n            broadcastBcMessage(this, encoding.toUint8Array(reply))\r\n          }\r\n        })\r\n      )\r\n    /**\r\n     * Listens to Yjs updates and sends them to remote peers\r\n     *\r\n     * @param {Uint8Array} update\r\n     * @param {any} origin\r\n     */\r\n    this._docUpdateHandler = (update, origin) => {\r\n      const encoder = encoding.createEncoder()\r\n      encoding.writeVarUint(encoder, messageSync)\r\n      syncProtocol.writeUpdate(encoder, update)\r\n      broadcastRoomMessage(this, encoding.toUint8Array(encoder))\r\n    }\r\n    /**\r\n     * Listens to Awareness updates and sends them to remote peers\r\n     *\r\n     * @param {any} changed\r\n     * @param {any} origin\r\n     */\r\n    this._awarenessUpdateHandler = ({ added, updated, removed }, origin) => {\r\n      const changedClients = added.concat(updated).concat(removed)\r\n      const encoderAwareness = encoding.createEncoder()\r\n      encoding.writeVarUint(encoderAwareness, messageAwareness)\r\n      encoding.writeVarUint8Array(encoderAwareness, awarenessProtocol.encodeAwarenessUpdate(this.awareness, changedClients))\r\n      broadcastRoomMessage(this, encoding.toUint8Array(encoderAwareness))\r\n    }\r\n\r\n    this._beforeUnloadHandler = () => {\r\n      awarenessProtocol.removeAwarenessStates(this.awareness, [doc.clientID], 'window unload')\r\n      rooms.forEach(room => {\r\n        room.disconnect()\r\n      })\r\n    }\r\n\r\n    if (typeof window !== 'undefined') {\r\n      window.addEventListener('beforeunload', this._beforeUnloadHandler)\r\n    } else if (typeof process !== 'undefined') {\r\n      process.on('exit', this._beforeUnloadHandler)\r\n    }\r\n  }\r\n\r\n  connect () {\r\n    this.doc.on('update', this._docUpdateHandler)\r\n    this.awareness.on('update', this._awarenessUpdateHandler)\r\n    // signal through all available signaling connections\r\n    announceSignalingInfo(this)\r\n    const roomName = this.name\r\n    bc.subscribe(roomName, this._bcSubscriber)\r\n    this.bcconnected = true\r\n    // broadcast peerId via broadcastchannel\r\n    broadcastBcPeerId(this)\r\n    // write sync step 1\r\n    const encoderSync = encoding.createEncoder()\r\n    encoding.writeVarUint(encoderSync, messageSync)\r\n    syncProtocol.writeSyncStep1(encoderSync, this.doc)\r\n    broadcastBcMessage(this, encoding.toUint8Array(encoderSync))\r\n    // broadcast local state\r\n    const encoderState = encoding.createEncoder()\r\n    encoding.writeVarUint(encoderState, messageSync)\r\n    syncProtocol.writeSyncStep2(encoderState, this.doc)\r\n    broadcastBcMessage(this, encoding.toUint8Array(encoderState))\r\n    // write queryAwareness\r\n    const encoderAwarenessQuery = encoding.createEncoder()\r\n    encoding.writeVarUint(encoderAwarenessQuery, messageQueryAwareness)\r\n    broadcastBcMessage(this, encoding.toUint8Array(encoderAwarenessQuery))\r\n    // broadcast local awareness state\r\n    const encoderAwarenessState = encoding.createEncoder()\r\n    encoding.writeVarUint(encoderAwarenessState, messageAwareness)\r\n    encoding.writeVarUint8Array(encoderAwarenessState, awarenessProtocol.encodeAwarenessUpdate(this.awareness, [this.doc.clientID]))\r\n    broadcastBcMessage(this, encoding.toUint8Array(encoderAwarenessState))\r\n  }\r\n\r\n  disconnect () {\r\n    // signal through all available signaling connections\r\n    signalingConns.forEach(conn => {\r\n      if (conn.connected) {\r\n        conn.send({ type: 'unsubscribe', topics: [this.name] })\r\n      }\r\n    })\r\n    awarenessProtocol.removeAwarenessStates(this.awareness, [this.doc.clientID], 'disconnect')\r\n    // broadcast peerId removal via broadcastchannel\r\n    const encoderPeerIdBc = encoding.createEncoder()\r\n    encoding.writeVarUint(encoderPeerIdBc, messageBcPeerId)\r\n    encoding.writeUint8(encoderPeerIdBc, 0) // remove peerId from other bc peers\r\n    encoding.writeVarString(encoderPeerIdBc, this.peerId)\r\n    broadcastBcMessage(this, encoding.toUint8Array(encoderPeerIdBc))\r\n\r\n    bc.unsubscribe(this.name, this._bcSubscriber)\r\n    this.bcconnected = false\r\n    this.doc.off('update', this._docUpdateHandler)\r\n    this.awareness.off('update', this._awarenessUpdateHandler)\r\n    this.webrtcConns.forEach(conn => conn.destroy())\r\n  }\r\n\r\n  destroy () {\r\n    this.disconnect()\r\n    if (typeof window !== 'undefined') {\r\n      window.removeEventListener('beforeunload', this._beforeUnloadHandler)\r\n    } else if (typeof process !== 'undefined') {\r\n      process.off('exit', this._beforeUnloadHandler)\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * @param {Y.Doc} doc\r\n * @param {WebrtcProvider} provider\r\n * @param {string} name\r\n * @param {CryptoKey|null} key\r\n * @return {Room}\r\n */\r\nconst openRoom = (doc, provider, name, key) => {\r\n  // there must only be one room\r\n  if (rooms.has(name)) {\r\n    throw error.create(`A Yjs Doc connected to room \"${name}\" already exists!`)\r\n  }\r\n  const room = new Room(doc, provider, name, key)\r\n  rooms.set(name, /** @type {Room} */ (room))\r\n  return room\r\n}\r\n\r\n/**\r\n * @param {SignalingConn} conn\r\n * @param {Room} room\r\n * @param {any} data\r\n */\r\nconst publishSignalingMessage = (conn, room, data) => {\r\n  if (room.key) {\r\n    cryptoutils.encryptJson(data, room.key).then(data => {\r\n      conn.send({ type: 'publish', topic: room.name, data: buffer.toBase64(data) })\r\n    })\r\n  } else {\r\n    conn.send({ type: 'publish', topic: room.name, data })\r\n  }\r\n}\r\n\r\nexport class SignalingConn extends ws.WebsocketClient {\r\n  constructor (url) {\r\n    super(url)\r\n    /**\r\n     * @type {Set<WebrtcProvider>}\r\n     */\r\n    this.providers = new Set()\r\n    this.on('connect', () => {\r\n      log(`connected (${url})`)\r\n      const topics = Array.from(rooms.keys())\r\n      this.send({ type: 'subscribe', topics })\r\n      rooms.forEach(room =>\r\n        publishSignalingMessage(this, room, { type: 'announce', from: room.peerId })\r\n      )\r\n    })\r\n    this.on('message', m => {\r\n      switch (m.type) {\r\n        case 'publish': {\r\n          const roomName = m.topic\r\n          const room = rooms.get(roomName)\r\n          if (room == null || typeof roomName !== 'string') {\r\n            return\r\n          }\r\n          const execMessage = data => {\r\n            const webrtcConns = room.webrtcConns\r\n            const peerId = room.peerId\r\n            if (data == null || data.from === peerId || (data.to !== undefined && data.to !== peerId) || room.bcConns.has(data.from)) {\r\n              // ignore messages that are not addressed to this conn, or from clients that are connected via broadcastchannel\r\n              return\r\n            }\r\n            const emitPeerChange = webrtcConns.has(data.from)\r\n              ? () => {}\r\n              : () =>\r\n                room.provider.emit('peers', [{\r\n                  removed: [],\r\n                  added: [data.from],\r\n                  webrtcPeers: Array.from(room.webrtcConns.keys()),\r\n                  bcPeers: Array.from(room.bcConns)\r\n                }])\r\n            switch (data.type) {\r\n              case 'announce':\r\n                if (webrtcConns.size < room.provider.maxConns) {\r\n                  //map.setIfUndefined(webrtcConns, data.from, () => new WebrtcConn(this, true, data.from, room))\r\n                  emitPeerChange()\r\n                }\r\n                break\r\n              case 'signal':\r\n                if (data.to === peerId) {\r\n                  //map.setIfUndefined(webrtcConns, data.from, () => new WebrtcConn(this, false, data.from, room)).peer.signal(data.signal)\r\n                  emitPeerChange()\r\n                }\r\n                break\r\n            }\r\n          }\r\n          if (room.key) {\r\n            if (typeof m.data === 'string') {\r\n              cryptoutils.decryptJson(buffer.fromBase64(m.data), room.key).then(execMessage)\r\n            }\r\n          } else {\r\n            execMessage(m.data)\r\n          }\r\n        }\r\n      }\r\n    })\r\n    this.on('disconnect', () => log(`disconnect (${url})`))\r\n  }\r\n}\r\n\r\n/**\r\n * @typedef {Object} ProviderOptions\r\n * @property {Array<string>} [signaling]\r\n * @property {string} [password]\r\n * @property {awarenessProtocol.Awareness} [awareness]\r\n * @property {number} [maxConns]\r\n * @property {boolean} [filterBcConns]\r\n * @property {any} [peerOpts]\r\n */\r\n\r\n/**\r\n * @extends Observable<string>\r\n */\r\nexport class WebrtcProvider extends Observable {\r\n  /**\r\n   * @param {string} roomName\r\n   * @param {Y.Doc} doc\r\n   * @param {ProviderOptions?} opts\r\n   */\r\n  constructor (\r\n    roomName,\r\n    doc,\r\n    {\r\n      signaling = ['wss://signaling.yjs.dev', 'wss://y-webrtc-signaling-eu.herokuapp.com', 'wss://y-webrtc-signaling-us.herokuapp.com'],\r\n      password = null,\r\n      awareness = new awarenessProtocol.Awareness(doc),\r\n      maxConns = 20 + math.floor(random.rand() * 15), // the random factor reduces the chance that n clients form a cluster\r\n      filterBcConns = true,\r\n      peerOpts = {} // simple-peer options. See https://github.com/feross/simple-peer#peer--new-peeropts\r\n    } = {}\r\n  ) {\r\n    super()\r\n    this.roomName = roomName\r\n    this.doc = doc\r\n    this.filterBcConns = filterBcConns\r\n    /**\r\n     * @type {awarenessProtocol.Awareness}\r\n     */\r\n    this.awareness = awareness\r\n    this.shouldConnect = false\r\n    this.signalingUrls = signaling\r\n    this.signalingConns = []\r\n    this.maxConns = maxConns\r\n    this.peerOpts = peerOpts\r\n    /**\r\n     * @type {PromiseLike<CryptoKey | null>}\r\n     */\r\n    this.key = password ? cryptoutils.deriveKey(password, roomName) : /** @type {PromiseLike<null>} */ (promise.resolve(null))\r\n    /**\r\n     * @type {Room|null}\r\n     */\r\n    this.room = null\r\n    this.key.then(key => {\r\n      this.room = openRoom(doc, this, roomName, key)\r\n      if (this.shouldConnect) {\r\n        this.room.connect()\r\n      } else {\r\n        this.room.disconnect()\r\n      }\r\n    })\r\n    this.connect()\r\n    this.destroy = this.destroy.bind(this)\r\n    doc.on('destroy', this.destroy)\r\n  }\r\n\r\n  /**\r\n   * @type {boolean}\r\n   */\r\n  get connected () {\r\n    return this.room !== null && this.shouldConnect\r\n  }\r\n\r\n  connect () {\r\n    this.shouldConnect = true\r\n    this.signalingUrls.forEach(url => {\r\n      const signalingConn = map.setIfUndefined(signalingConns, url, () => new SignalingConn(url))\r\n      this.signalingConns.push(signalingConn)\r\n      signalingConn.providers.add(this)\r\n    })\r\n    if (this.room) {\r\n      this.room.connect()\r\n    }\r\n  }\r\n\r\n  disconnect () {\r\n    this.shouldConnect = false\r\n    this.signalingConns.forEach(conn => {\r\n      conn.providers.delete(this)\r\n      if (conn.providers.size === 0) {\r\n        conn.destroy()\r\n        signalingConns.delete(conn.url)\r\n      }\r\n    })\r\n    if (this.room) {\r\n      this.room.disconnect()\r\n    }\r\n  }\r\n\r\n  destroy () {\r\n    this.doc.off('destroy', this.destroy)\r\n    // need to wait for key before deleting room\r\n    this.key.then(() => {\r\n      /** @type {Room} */ (this.room).destroy()\r\n      rooms.delete(this.roomName)\r\n    })\r\n    super.destroy()\r\n  }\r\n}\r\n"],"names":["string.encodeUtf8","promise.resolve","encoding.createEncoder","encoding.writeVarString","encoding.writeVarUint8Array","encoding.toUint8Array","encoding.writeAny","decoding.createDecoder","decoding.readVarString","promise.reject","error.create","decoding.readVarUint8Array","decoding.readAny","logging.createModuleLogger","decoding.readVarUint","encoding.writeVarUint","syncProtocol.readSyncMessage","syncProtocol.messageYjsSyncStep2","syncProtocol.messageYjsSyncStep1","awarenessProtocol.encodeAwarenessUpdate","awarenessProtocol.applyAwarenessUpdate","decoding.readUint8","logging.BOLD","logging.UNBOLD","cryptoutils.encrypt","bc.publish","encoding.writeUint8","random.uuidv4","createMutex","cryptoutils.decrypt","syncProtocol.writeUpdate","awarenessProtocol.removeAwarenessStates","bc.subscribe","syncProtocol.writeSyncStep1","syncProtocol.writeSyncStep2","bc.unsubscribe","cryptoutils.encryptJson","buffer.toBase64","ws.WebsocketClient","cryptoutils.decryptJson","buffer.fromBase64","Observable","awarenessProtocol.Awareness","math.floor","random.rand","cryptoutils.deriveKey","map.setIfUndefined"],"mappings":"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"}